<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Éû„Ç§Êú¨Ê£ö„Éó„É≠ - Complete Edition</title>
    <style>
        :root {
            --shelf-dark: #5d4037;
            --shelf-light: #8d6e63;
            --bg-color: #f4f1ea;
            --read-color: #2ecc71;
            --reading-color: #3498db;
        }

        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            background: var(--bg-color);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1100px;
            margin: auto;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        h1 {
            color: var(--shelf-dark);
            text-align: center;
            margin-bottom: 30px;
        }

        /* ÂÖ•Âäõ„Éï„Ç©„Éº„É† */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        label {
            display: block;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 5px;
            color: #666;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
        }

        .upload-options {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .preview-box {
            width: 60px;
            height: 80px;
            border: 2px dashed #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: #eee;
            flex-shrink: 0;
        }

        .preview-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }

        .btn-add {
            background: var(--shelf-dark);
            color: white;
            width: 100%;
            margin-top: 15px;
            font-size: 16px;
        }

        .btn-add:hover {
            background: #3e2723;
        }

        /* Êú¨Ê£öUI */
        .shelf-container {
            background: var(--shelf-light);
            padding: 40px 20px 20px;
            border-radius: 8px;
            box-shadow: inset 0 10px 20px rgba(0, 0, 0, 0.3);
            margin-top: 20px;
        }

        .shelf {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 25px;
        }

        .book-wrapper {
            perspective: 1000px;
            height: 190px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            position: relative;
        }

        .book {
            width: 100px;
            height: 160px;
            background: #444;
            position: relative;
            cursor: pointer;
            box-shadow: -5px 5px 15px rgba(0, 0, 0, 0.4);
            transition: 0.3s;
            transform: rotateY(-15deg);
            border-radius: 2px 4px 4px 2px;
        }

        .book:hover {
            transform: rotateY(0deg) translateY(-10px) scale(1.05);
            z-index: 10;
        }

        .book img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: inherit;
        }

        /* „Çπ„ÉÜ„Éº„Çø„ÇπË°®Áèæ */
        .status-badge {
            position: absolute;
            top: -10px;
            right: -5px;
            z-index: 20;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            color: white;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .status-read {
            background: var(--read-color);
        }

        .status-reading {
            background: var(--reading-color);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }
        }

        .book.is-read {
            opacity: 0.7;
        }

        .book.is-reading {
            border: 3px solid var(--reading-color);
            box-shadow: 0 0 15px var(--reading-color);
        }

        /* „Çø„Éñ„Å®„Éï„Ç£„É´„Çø„Éº */
        .filter-section {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .tab {
            padding: 8px 16px;
            background: #e0e0e0;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            transition: 0.2s;
        }

        .tab.active {
            background: var(--shelf-dark);
            color: white;
        }

        /* „É¢„Éº„ÉÄ„É´ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            width: 95%;
            max-width: 600px;
            margin: 40px auto;
            padding: 30px;
            border-radius: 15px;
            position: relative;
            max-height: 85vh;
            overflow-y: auto;
        }

        .close {
            position: absolute;
            right: 20px;
            top: 15px;
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }

        .modal-body {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .modal-img {
            width: 150px;
            height: 220px;
            background: #ddd;
            object-fit: cover;
            border-radius: 5px;
            flex-shrink: 0;
        }

        .edit-mode {
            display: none;
        }

        .is-editing .view-mode {
            display: none;
        }

        .is-editing .edit-mode {
            display: block;
        }

        .footer-btns {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
        }

        .btn-edit {
            background: #f39c12;
            color: white;
        }

        .btn-save {
            background: #2ecc71;
            color: white;
        }
    </style>
</head>

<body>

    <div class="container">
        <h1>üìö „Éá„Ç∏„Çø„É´„Éª„Éû„Ç§Êú¨Ê£ö Pro</h1>

        <div class="card">
            <div class="form-grid">
                <div><label>„Çø„Ç§„Éà„É´ *</label><input type="text" id="titleIn"></div>
                <div><label>ËëóËÄÖ</label><input type="text" id="authorIn"></div>
                <div>
                    <label>„Çπ„ÉÜ„Éº„Çø„Çπ</label>
                    <select id="statusIn">
                        <option value="Êú™Ë™≠">Êú™Ë™≠</option>
                        <option value="Ë™≠Êõ∏‰∏≠">Ë™≠Êõ∏‰∏≠</option>
                        <option value="Êó¢Ë™≠">Êó¢Ë™≠</option>
                    </select>
                </div>
                <div><label>„Ç∏„É£„É≥„É´</label><select id="genreIn"></select></div>
            </div>

            <div style="margin-top: 15px;">
                <label>ÁîªÂÉè„ÅÆ„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÔºà„Éï„Ç°„Ç§„É´ÈÅ∏Êäû or URLÔºâ</label>
                <div class="upload-options">
                    <div id="previewArea" class="preview-box"><span style="color:#999; font-size:10px;">No Image</span>
                    </div>
                    <div style="flex-grow: 1;">
                        <input type="file" id="fileIn" accept="image/*" onchange="handleFile(this)"
                            style="margin-bottom: 5px; font-size: 12px;">
                        <input type="text" id="urlIn" placeholder="ÁîªÂÉèURL„ÇíË≤º„Çä‰ªò„Åë" oninput="handleUrl(this.value)">
                    </div>
                </div>
            </div>
            <button class="btn btn-add" onclick="addBook()">Êú¨„ÇíÊ£ö„Å´‰∏¶„Åπ„Çã</button>
        </div>

        <div class="card" style="padding: 10px 20px; display: flex; gap: 10px;">
            <input type="text" id="newGenreIn" placeholder="Êñ∞„Åó„ÅÑ„Ç∏„É£„É≥„É´„ÇíËøΩÂä†">
            <button class="btn" style="background:#607d8b; color:white; padding:8px 15px;"
                onclick="addGenre()">ËøΩÂä†</button>
        </div>

        <div class="filter-section" id="genreTabs"></div>
        <div class="filter-section">
            <div class="tab active f-status" onclick="setStatusFilter('„Åô„Åπ„Å¶', this)">„Åô„Åπ„Å¶</div>
            <div class="tab f-status" onclick="setStatusFilter('Êú™Ë™≠', this)">Êú™Ë™≠</div>
            <div class="tab f-status" onclick="setStatusFilter('Ë™≠Êõ∏‰∏≠', this)">Ë™≠Êõ∏‰∏≠</div>
            <div class="tab f-status" onclick="setStatusFilter('Êó¢Ë™≠', this)">Êó¢Ë™≠</div>
        </div>

        <div class="shelf-container">
            <div class="shelf" id="shelf"></div>
        </div>
    </div>

    <div id="modal" class="modal">
        <div id="modalContent" class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>

            <div class="modal-body">
                <img id="vImg" class="modal-img" src="" alt="">
                <div style="flex-grow: 1;">
                    <div class="view-mode">
                        <h2 id="vTitle" style="margin-top:0;"></h2>
                        <p><strong>ËëóËÄÖ:</strong> <span id="vAuthor"></span></p>
                        <p><strong>„Çπ„ÉÜ„Éº„Çø„Çπ:</strong> <span id="vStatus"></span></p>
                        <p><strong>„Ç∏„É£„É≥„É´:</strong> <span id="vGenre"></span></p>
                    </div>
                    <div class="edit-mode">
                        <label>„Çø„Ç§„Éà„É´</label><input type="text" id="eTitle">
                        <label>ËëóËÄÖ</label><input type="text" id="eAuthor">
                        <label>„Çπ„ÉÜ„Éº„Çø„Çπ</label>
                        <select id="eStatus">
                            <option value="Êú™Ë™≠">Êú™Ë™≠</option>
                            <option value="Ë™≠Êõ∏‰∏≠">Ë™≠Êõ∏‰∏≠</option>
                            <option value="Êó¢Ë™≠">Êó¢Ë™≠</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="view-mode">
                <label>Ë™≠Êõ∏ÊÑüÊÉ≥Êñá</label>
                <div id="vReview"
                    style="background:#f9f9f9; padding:15px; border-radius:8px; white-space:pre-wrap; min-height:100px; border:1px solid #eee;">
                </div>
            </div>
            <div class="edit-mode">
                <label>ÊÑüÊÉ≥„ÇíÁ∑®ÈõÜ</label>
                <textarea id="eReview" rows="6"></textarea>
            </div>

            <div class="footer-btns">
                <button class="btn btn-delete" onclick="deleteBook()">ÂâäÈô§</button>
                <div class="view-mode">
                    <button class="btn btn-edit" onclick="toggleEdit(true)">Á∑®ÈõÜ„ÉªÊÑüÊÉ≥„ÇíÊõ∏„Åè</button>
                </div>
                <div class="edit-mode">
                    <button class="btn btn-save" onclick="saveEdit()">‰øùÂ≠ò</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let books = JSON.parse(localStorage.getItem('shelf_final_books')) || [];
        let genres = JSON.parse(localStorage.getItem('shelf_final_genres')) || ["„Åô„Åπ„Å¶", "Êú™ÂàÜÈ°û", "„Éü„Çπ„ÉÜ„É™„Éº", "Ê≠¥Âè≤", "Êó•Êú¨ÊñáÂ≠¶"];
        let currentId = null;
        let filterGenre = "„Åô„Åπ„Å¶";
        let filterStatus = "„Åô„Åπ„Å¶";
        let tempImageData = ""; // ÁîªÂÉè„Éá„Éº„Çø„ÅÆ‰∏ÄÊôÇ‰øùÊåÅ

        function init() {
            renderGenreOptions();
            renderGenreTabs();
            renderBooks();
        }

        // --- ÁîªÂÉèÂá¶ÁêÜ ---
        function handleFile(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    tempImageData = e.target.result;
                    updatePreview(tempImageData);
                    document.getElementById('urlIn').value = ""; // URL„Çí„ÇØ„É™„Ç¢
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function handleUrl(url) {
            if (url) {
                tempImageData = url;
                updatePreview(url);
                document.getElementById('fileIn').value = ""; // „Éï„Ç°„Ç§„É´ÈÅ∏Êäû„Çí„ÇØ„É™„Ç¢
            }
        }

        function updatePreview(src) {
            const preview = document.getElementById('previewArea');
            preview.innerHTML = `<img src="${src}">`;
        }

        // --- Êõ∏Á±çÁôªÈå≤ ---
        function addBook() {
            const title = document.getElementById('titleIn').value.trim();
            if (!title) return alert("„Çø„Ç§„Éà„É´„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");

            const newBook = {
                id: Date.now(),
                title,
                author: document.getElementById('authorIn').value || "‰∏çÊòé",
                status: document.getElementById('statusIn').value,
                genre: document.getElementById('genreIn').value,
                img: tempImageData,
                review: ""
            };

            books.push(newBook);
            save();
            renderBooks();
            // „Éï„Ç©„Éº„É†„É™„Çª„ÉÉ„Éà
            document.getElementById('titleIn').value = "";
            document.getElementById('authorIn').value = "";
            document.getElementById('fileIn').value = "";
            document.getElementById('urlIn').value = "";
            document.getElementById('previewArea').innerHTML = '<span style="color:#999; font-size:10px;">No Image</span>';
            tempImageData = "";
        }

        // --- ÊèèÁîªÂá¶ÁêÜ ---
        function renderBooks() {
            const shelf = document.getElementById('shelf');
            shelf.innerHTML = "";

            let filtered = books.filter(b =>
                (filterGenre === "„Åô„Åπ„Å¶" || b.genre === filterGenre) &&
                (filterStatus === "„Åô„Åπ„Å¶" || b.status === filterStatus)
            );

            filtered.forEach(b => {
                const wrap = document.createElement('div');
                wrap.className = 'book-wrapper';

                if (b.status === "Êó¢Ë™≠") wrap.innerHTML += `<div class="status-badge status-read">‚úì Êó¢Ë™≠</div>`;
                if (b.status === "Ë™≠Êõ∏‰∏≠") wrap.innerHTML += `<div class="status-badge status-reading">üìñ Ë™≠‰∏≠</div>`;

                const book = document.createElement('div');
                book.className = `book ${b.status === 'Êó¢Ë™≠' ? 'is-read' : ''} ${b.status === 'Ë™≠Êõ∏‰∏≠' ? 'is-reading' : ''}`;
                book.onclick = () => openModal(b.id);

                if (b.img) {
                    book.innerHTML = `<img src="${b.img}" onerror="this.src='https://via.placeholder.com/100x160?text=No+Image'">`;
                } else {
                    book.innerHTML = `<div style="color:white; font-size:10px; padding:15px; text-align:center;">${b.title}</div>`;
                    book.style.background = `hsl(${b.id % 360}, 40%, 30%)`;
                }

                wrap.appendChild(book);
                shelf.appendChild(wrap);
            });
        }

        // --- „Ç∏„É£„É≥„É´„Éª„Çø„ÉñÁÆ°ÁêÜ ---
        function addGenre() {
            const val = document.getElementById('newGenreIn').value.trim();
            if (val && !genres.includes(val)) {
                genres.push(val);
                save(); renderGenreOptions(); renderGenreTabs();
                document.getElementById('newGenreIn').value = "";
            }
        }

        function renderGenreOptions() {
            const html = genres.filter(g => g !== "„Åô„Åπ„Å¶").map(g => `<option value="${g}">${g}</option>`).join('');
            document.getElementById('genreIn').innerHTML = html;
        }

        function renderGenreTabs() {
            const area = document.getElementById('genreTabs');
            area.innerHTML = genres.map(g => `<div class="tab ${g === filterGenre ? 'active' : ''}" onclick="setGenreFilter('${g}')">${g}</div>`).join('');
        }

        function setGenreFilter(g) { filterGenre = g; renderGenreTabs(); renderBooks(); }
        function setStatusFilter(s, el) {
            filterStatus = s;
            document.querySelectorAll('.f-status').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            renderBooks();
        }

        // --- „É¢„Éº„ÉÄ„É´„ÉªÁ∑®ÈõÜ ---
        function openModal(id) {
            currentId = id;
            const b = books.find(x => x.id === id);
            document.getElementById('vTitle').innerText = b.title;
            document.getElementById('vAuthor').innerText = b.author;
            document.getElementById('vStatus').innerText = b.status;
            document.getElementById('vGenre').innerText = b.genre;
            document.getElementById('vReview').innerText = b.review || "ÊÑüÊÉ≥„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ";
            document.getElementById('vImg').src = b.img || "https://via.placeholder.com/150x220?text=No+Image";

            document.getElementById('eTitle').value = b.title;
            document.getElementById('eStatus').value = b.status;
            document.getElementById('eReview').value = b.review;

            toggleEdit(false);
            document.getElementById('modal').style.display = 'block';
        }

        function toggleEdit(on) {
            document.getElementById('modalContent').classList.toggle('is-editing', on);
        }

        function saveEdit() {
            const b = books.find(x => x.id === currentId);
            b.title = document.getElementById('eTitle').value;
            b.status = document.getElementById('eStatus').value;
            b.review = document.getElementById('eReview').value;
            save(); renderBooks(); openModal(currentId);
        }

        function deleteBook() {
            if (confirm("„Åì„ÅÆÊú¨„ÇíÊú¨Ê£ö„Åã„ÇâÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) {
                books = books.filter(x => x.id !== currentId);
                save(); renderBooks(); closeModal();
            }
        }

        function closeModal() { document.getElementById('modal').style.display = 'none'; }
        function save() {
            localStorage.setItem('shelf_final_books', JSON.stringify(books));
            localStorage.setItem('shelf_final_genres', JSON.stringify(genres));
        }

        window.onclick = (e) => { if (e.target.className === 'modal') closeModal(); }
        init();
    </script>
</body>

</html>