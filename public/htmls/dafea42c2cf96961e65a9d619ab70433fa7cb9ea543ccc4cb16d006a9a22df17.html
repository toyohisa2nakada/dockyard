<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>認知症予防トレーニングゲーム</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }

        button,
        select,
        input {
            font-size: 18px;
            margin: 6px;
            padding: 8px 16px;
        }

        #timer {
            font-size: 22px;
            color: red;
        }

        .number {
            font-size: 36px;
            letter-spacing: 10px;
        }

        .grid {
            display: grid;
            justify-content: center;
            gap: 5px;
            margin-top: 15px;
        }

        .cell {
            width: 60px;
            height: 60px;
            font-size: 20px;
        }

        .retire {
            background-color: #ccc;
        }
    </style>
</head>

<body>

    <h1>認知症予防トレーニングゲーム</h1>

    <div id="menu">
        難易度：
        <select id="difficulty">
            <option value="easy">Easy</option>
            <option value="normal">Normal</option>
            <option value="hard">Hard</option>
        </select>
        <br><br>
        <button onclick="mathGame()">計算ゲーム</button>
        <button onclick="memoryNumberGame()">数字記憶ゲーム</button>
        <button onclick="memoryGame()">神経衰弱</button>
    </div>

    <div id="game"></div>

    <script>
        const gameDiv = document.getElementById("game");
        const menuDiv = document.getElementById("menu");
        let timerInterval;

        /* ===== 正解音（ピンポーン） ===== */
        function playCorrectSound() {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            osc.connect(ctx.destination);
            osc.frequency.setValueAtTime(1000, ctx.currentTime);
            osc.frequency.setValueAtTime(600, ctx.currentTime + 0.25);
            osc.start();
            osc.stop(ctx.currentTime + 0.4);
        }

        /* ===== ゲームオーバー音 ===== */
        function playGameOverSound() {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();

            osc.type = "sine";
            osc.frequency.setValueAtTime(400, ctx.currentTime);
            gain.gain.setValueAtTime(0.3, ctx.currentTime);

            osc.connect(gain);
            gain.connect(ctx.destination);

            osc.start();
            osc.stop(ctx.currentTime + 0.8);
        }

        /* ===== 難易度設定 ===== */
        function settings() {
            const d = document.getElementById("difficulty").value;
            if (d === "easy") return { time: 10, q: 3, len: 3, size: 4 };
            if (d === "normal") return { time: 20, q: 5, len: 5, size: 5 };
            return { time: 30, q: 7, len: 7, size: 6 };
        }

        /* 神経衰弱専用制限時間 */
        function memoryTimeSetting() {
            const d = document.getElementById("difficulty").value;
            if (d === "easy") return 60;
            if (d === "normal") return 180;
            return 300;
        }

        /* ===== タイマー ===== */
        function startTimer(sec, onEnd) {
            clearInterval(timerInterval);
            let left = sec;
            timerInterval = setInterval(() => {
                document.getElementById("timer").textContent =
                    `残り時間：${Math.floor(left / 60)}:${("0" + left % 60).slice(-2)}`;
                left--;
                if (left < 0) {
                    clearInterval(timerInterval);
                    onEnd();
                }
            }, 1000);
        }

        /* ===== 共通画面 ===== */
        function retireGame() {
            clearInterval(timerInterval);
            backToTitle();
        }

        function gameOver(score = 0) {
            clearInterval(timerInterval);
            playGameOverSound();
            gameDiv.innerHTML = `
        <h2>ゲームオーバー</h2>
        <p>スコア：${score}</p>
        <button onclick="backToTitle()">タイトルに戻る</button>
    `;
        }

        function clearGame(score = 0) {
            clearInterval(timerInterval);
            gameDiv.innerHTML = `
        <h2>クリア！</h2>
        <p>スコア：${score}</p>
        <button onclick="backToTitle()">タイトルに戻る</button>
    `;
        }

        function backToTitle() {
            clearInterval(timerInterval);
            gameDiv.innerHTML = "";
            menuDiv.style.display = "block";
        }

        /* =====================
           計算ゲーム
        ===================== */
        function mathGame() {
            menuDiv.style.display = "none";
            const s = settings();
            const level = document.getElementById("difficulty").value;
            let count = 0;

            gameDiv.innerHTML = `
        <div id="timer"></div>
        <button class="retire" onclick="retireGame()">リタイア</button>
        <div id="question"></div>
    `;
            startTimer(s.time, () => gameOver(count));
            next();

            function next() {
                if (count >= s.q) {
                    clearGame(count);
                    return;
                }

                const q = createMathQuestion(level);
                document.getElementById("question").innerHTML = `
            <h3>問題 ${count + 1} / ${s.q}</h3>
            <h2>${q.text}</h2>
            <input id="answer" type="number">
            <br><br>
            <button onclick="check()">答える</button>
        `;

                const input = document.getElementById("answer");
                input.focus();
                input.onkeydown = e => {
                    if (e.key === "Enter") check();
                };

                window.check = () => {
                    if (Number(input.value) === q.answer) {
                        playCorrectSound();
                        count++;
                        next();
                    } else {
                        gameOver(count);
                    }
                };
            }
        }

        /* ===== 計算問題生成 ===== */
        function createMathQuestion(level) {
            let a, b, text, answer;

            if (level === "easy") {
                a = rand(1, 20);
                b = rand(1, 20);
                if (Math.random() < 0.5) {
                    text = `${a} ＋ ${b} = ?`;
                    answer = a + b;
                } else {
                    text = `${a} − ${b} = ?`;
                    answer = a - b;
                }
            }
            else if (level === "normal") {
                if (Math.random() < 0.5) {
                    a = rand(10, 99);
                    b = rand(10, 99);
                    text = `${a} ＋ ${b} = ?`;
                    answer = a + b;
                } else {
                    a = rand(2, 9);
                    b = rand(10, 99);
                    text = `${a} × ${b} = ?`;
                    answer = a * b;
                }
            }
            else {
                const r = Math.random();
                if (r < 0.33) {
                    a = rand(10, 99);
                    b = rand(10, 99);
                    text = `${a} × ${b} = ?`;
                    answer = a * b;
                } else if (r < 0.66) {
                    b = rand(2, 9);
                    answer = rand(2, 50);
                    a = b * answer;
                    text = `${a} ÷ ${b} = ?`;
                } else {
                    a = rand(100, 999);
                    b = rand(100, 999);
                    if (Math.random() < 0.5) {
                        text = `${a} ＋ ${b} = ?`;
                        answer = a + b;
                    } else {
                        text = `${a} − ${b} = ?`;
                        answer = a - b;
                    }
                }
            }
            return { text, answer };
        }

        /* =====================
           数字記憶ゲーム
        ===================== */
        function memoryNumberGame() {
            menuDiv.style.display = "none";
            const s = settings();
            let answer = "";
            for (let i = 0; i < s.len; i++) answer += rand(0, 9);

            gameDiv.innerHTML = `
        <button class="retire" onclick="retireGame()">リタイア</button>
        <p>次の数字を覚えてください（3秒）</p>
        <div class="number">${answer}</div>
    `;

            setTimeout(() => {
                gameDiv.innerHTML = `
            <div id="timer"></div>
            <button class="retire" onclick="retireGame()">リタイア</button>
            <input id="answer" type="text">
            <br><br>
            <button onclick="check()">決定</button>
        `;
                startTimer(s.time, () => gameOver(0));

                const input = document.getElementById("answer");
                input.focus();
                input.onkeydown = e => {
                    if (e.key === "Enter") check();
                };

                window.check = () => {
                    if (input.value === answer) {
                        playCorrectSound();
                        clearGame(s.len);
                    } else {
                        gameOver(0);
                    }
                };
            }, 3000);
        }

        /* =====================
           神経衰弱
        ===================== */
        function memoryGame() {
            menuDiv.style.display = "none";
            const s = settings();
            let nums = [];
            for (let i = 1; i <= (s.size * s.size) / 2; i++) nums.push(i, i);
            nums.sort(() => Math.random() - 0.5);

            let opened = [];
            let matched = 0;

            gameDiv.innerHTML = `
        <div id="timer"></div>
        <button class="retire" onclick="retireGame()">リタイア</button>
    `;

            const grid = document.createElement("div");
            grid.className = "grid";
            grid.style.gridTemplateColumns = `repeat(${s.size}, 60px)`;

            nums.forEach(n => {
                const btn = document.createElement("button");
                btn.className = "cell";
                btn.onclick = () => open(btn, n);
                grid.appendChild(btn);
            });

            gameDiv.appendChild(grid);
            startTimer(memoryTimeSetting(), () => gameOver(matched));

            function open(btn, n) {
                if (btn.textContent || opened.length === 2) return;
                btn.textContent = n;
                opened.push(btn);

                if (opened.length === 2) {
                    if (opened[0].textContent === opened[1].textContent) {
                        playCorrectSound();
                        matched += 2;
                        opened = [];
                        if (matched === nums.length) clearGame(matched);
                    } else {
                        setTimeout(() => {
                            opened.forEach(b => b.textContent = "");
                            opened = [];
                        }, 800);
                    }
                }
            }
        }

        /* ===== 乱数 ===== */
        function rand(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }
    </script>

</body>

</html>