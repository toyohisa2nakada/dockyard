<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <title>æ„Ÿæƒ…åˆ¤å®šãƒãƒ£ãƒƒãƒˆAI</title>
    <!-- TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0/dist/tf.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
        }

        textarea {
            width: 100%;
            height: 80px;
        }

        button {
            margin-top: 10px;
            padding: 8px 16px;
        }

        #result {
            margin-top: 20px;
            font-size: 18px;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <h1>æ„Ÿæƒ…åˆ¤å®šãƒãƒ£ãƒƒãƒˆAI</h1>
    <p>æ–‡ç« ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š</p>
    <textarea id="inputText"></textarea><br />
    <button onclick="predictEmotion()">åˆ¤å®šã™ã‚‹</button>
    <div id="result"></div>
    <script>
        // ===== 1. å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ =====
        const texts = [
            "ã¨ã¦ã‚‚æ¥½ã—ã„",
            "å¬‰ã—ã„æ°—æŒã¡",
            "æœ€é«˜ã®ä¸€æ—¥",
            "æœ€æ‚ªãªæ°—åˆ†",
            "ã¨ã¦ã‚‚ç–²ã‚ŒãŸ",
            "æ‚²ã—ã„å‡ºæ¥äº‹",
            "ä»Šæ—¥ã¯å­¦æ ¡ã«è¡Œã£ãŸ",
            "æœ¬ã‚’èª­ã‚“ã ",
            "æ˜¼ã”ã¯ã‚“ã‚’é£Ÿã¹ãŸ"
        ];
        // 0: ãƒã‚¸ãƒ†ã‚£ãƒ–, 1: ãƒã‚¬ãƒ†ã‚£ãƒ–, 2: æ™®é€š
        const labels = [0, 0, 0, 1, 1, 1, 2, 2, 2];
        // ===== 2. å˜èªè¾æ›¸ =====
        const vocab = {};
        let vocabIndex = 1;
        function tokenize(text) {
            return text.split("");
        }
        texts.forEach(t => {
            tokenize(t).forEach(ch => {
                if (!(ch in vocab)) {
                    vocab[ch] = vocabIndex++;
                }
            });
        });
        const vocabSize = vocabIndex;
        function textToTensor(text, maxLen = 20) {
            const tokens = tokenize(text).map(ch => vocab[ch] || 0);
            while (tokens.length < maxLen) tokens.push(0);
            return tokens.slice(0, maxLen);
        }
        const xs = tf.tensor2d(texts.map(t => textToTensor(t)));
        const ys = tf.tensor1d(labels, "int32");
        // ===== 3. ãƒ¢ãƒ‡ãƒ«ä½œæˆï¼ˆAttentionã‚ã‚Šï¼‰ =====
        const input = tf.input({ shape: [20], dtype: "int32" });
        const embedding = tf.layers.embedding({
            inputDim: vocabSize,
            outputDim: 16,
            maskZero: true
        }).apply(input);
        // Attentionï¼ˆç°¡æ˜“çš„ãªé‡ã¿ä»˜ãå¹³å‡ï¼‰
        const attentionWeights = tf.layers.dense({
            units: 1,
            activation: "softmax"
        }).apply(embedding);
        const weighted = tf.layers.multiply().apply([embedding, attentionWeights]);
        const pooled = tf.layers.globalAveragePooling1d().apply(weighted);
        const output = tf.layers.dense({
            units: 3,
            activation: "softmax"
        }).apply(pooled);
        const model = tf.model({ inputs: input, outputs: output });
        model.compile({
            optimizer: tf.train.adam(0.01),
            loss: "sparseCategoricalCrossentropy",
            metrics: ["accuracy"]
        });
        // ===== 4. å­¦ç¿’ =====
        async function train() {
            await model.fit(xs, ys, {
                epochs: 50,
                verbose: 0
            });
            console.log("å­¦ç¿’å®Œäº†");
        }
        train();
        // ===== 5. äºˆæ¸¬ =====
        async function predictEmotion() {
            const text = document.getElementById("inputText").value;
            const inputTensor = tf.tensor2d([textToTensor(text)]);
            const prediction = model.predict(inputTensor);
            const result = prediction.argMax(-1).dataSync()[0];
            let emotion = "";
            if (result === 0) emotion = "ğŸ˜Š ãƒã‚¸ãƒ†ã‚£ãƒ–";
            if (result === 1) emotion = "ğŸ˜¢ ãƒã‚¬ãƒ†ã‚£ãƒ–";
            if (result === 2) emotion = "ğŸ˜ æ™®é€š";
            document.getElementById("result").innerText =
                "åˆ¤å®šçµæœï¼š" + emotion;
        }
    </script>
</body>

</html>